<html>
<head>
<title>Syntaxer</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="favicon.ico?nocache=syntaxer" />

<link type="text/css" rel="stylesheet" href="css/styles.css" />
<script type="text/javascript" src="js/codemirror.js"></script>
<!-- modes -->
<script type="text/javascript" src="js/mode/javascript.js"></script>
<script type="text/javascript" src="js/mode/css.js"></script>
<script type="text/javascript" src="js/mode/xml.js"></script>
<script type="text/javascript" src="js/mode/htmlmixed.js"></script>
<script type="text/javascript" src="js/mode/webglslvert.js"></script>
<script type="text/javascript" src="js/mode/webglslfrag.js"></script>
<!-- end modes -->
<!-- addons -->
<script type="text/javascript" src="js/addon/show-hint.js"></script>
<script type="text/javascript" src="js/addon/hint-functions.js"></script>
<script type="text/javascript" src="js/addon/active-line.js"></script>
<script type="text/javascript" src="js/addon/gljs-hint.js"></script>
<!--<script type="text/javascript" src="js/addon/anyword-hint.js"></script>-->
<!-- end addons -->
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript">
  var svgDir='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512"><path d="M357.84 398.577l61.104-162.945h-264.784l-61.104 162.945zM133.792 215.264l-40.736 183.312v-264.784h91.655l40.736 40.736h132.393v40.736z"></path></svg>';
  var svgFile='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 384 512"><path d="M161.448 215.264l-50.92 50.92 50.92 50.92 20.368-20.368-30.552-30.552 30.552-30.552-20.368-20.368zM202.184 235.632l30.552 30.552-30.552 30.552 20.368 20.368 50.92-50.92-50.92-50.92-20.368 20.368zM253.104 113.424h-183.312v285.152h244.417v-224.048l-61.104-61.104zM293.84 378.209h-203.68v-244.417h142.577l61.104 61.104v183.312z"></path></svg>';

  //gets a query string json from the url
  function getQs(){
    var qs={};
    var fromUrl=document.location.href;
    if(fromUrl.indexOf('?')!==-1){
      fromUrl=fromUrl.substring(fromUrl.indexOf('?')+'?'.length);
      var qsArray=fromUrl.split('&');
      for(var q=0;q<qsArray.length;q++){
        var qsStr=qsArray[q];
        var keyVal=qsStr.split('=');
        if(keyVal.length>1){
          var key=keyVal[0].trim();
          var val=keyVal[1].trim();
          qs[key]=val;
        }
      }
    } return qs;
  }
  function getActiveTabLi(){
    return jQuery('#tabs:first').children('ul:first').children('li.active[path]:first');
  }
  function getTemplateTabLi(){
    return jQuery('#tabs:first').children('ul:first').children('li.template:first');
  }
  function getElemPath(arg){
    var path;
    if(arg!=undefined){
      if(typeof arg==='string'){
        path=arg;
        if(path!=='.'){
          //make sure this is a real path and not just a random string
          if(jQuery('#tabs > ul > li[path="'+path+'"]:first').length<1){path=undefined;}
        }else{
          //get the current active for '.'
          var li=getActiveTabLi();
          path=li.attr('path');
          if(path!=undefined){
            path=path.trim();
            if(path.length<1){path=undefined;}
          }
        }
      }else if(arg.attr){
        //if this element doesn't have a path attribute
        path=arg.attr('path');
        if(path==undefined){path='';}
        if(path.length<1){
          //if a parent element has a path attribute
          var parent=arg.parents('[path]:first');
          if(parent.length>0){
            path=parent.attr('path');
          }else{
            //no path associated with this element
            path=undefined;
          }
        }
      }
    }
    return path;
  }
  function getPathName(which){
    var name;
    var path=getElemPath(which);
    if(path!=undefined){
      name=path;
      if(name.indexOf('/')!==-1){
        name=name.substring(name.lastIndexOf('/')+'/'.length);
      }
    }
    return name;
  }
  function getEditorDiv(which){
    var div;
    var path=getElemPath(which);
    if(path!=undefined){
      div=jQuery('#file-content:first').children('div[path="'+path+'"]:first');
      if(div.length<1){
        div=undefined;
      }
    }
    return div;
  }
  function getCodeMirrorObj(which){
    var cm;
    //if there is a codemirror object for this
    var div=getEditorDiv(which);
    if(div!=undefined){
      if(div[0].hasOwnProperty('codeMirror')){
        cm=div[0]['codeMirror'];
      }
    }
    return cm;
  }
  function getPathExt(which){
    var ext;
    var path=getElemPath(which);
    if(path!=undefined){
      ext=path;
      if(ext.indexOf('.')!==-1){
        ext=ext.substring(ext.lastIndexOf('.')+'.'.length);
      } ext=ext.toLowerCase(); ext=ext.trim();
      if(ext==='html'){
        var tabLi=getTabLi(path);
        if(tabLi.hasClass('template')){
          ext='template';
        }
      }
    }
    return ext;
  }
  function getTabLi(which){
    var li;
    var path=getElemPath(which);
    if(path!=undefined){
      li=jQuery('#tabs:first').children('ul:first').children('li[path="'+path+'"]:first');
      if(li.length<1){
        li=undefined;
      }
    }
    return li;
  }
  //get the current editor code for a tab
  function getFileContent(which){
    var content;
    var div=getEditorDiv(which);
    if(div!=undefined){
      //if the code mirror editor is initialized for this div
      if(div[0].hasOwnProperty('codeMirror')){
        content=div[0]['codeMirror']['object'].getValue();
      }else{
        //code mirror not initialized, so just get the content from the textarea
        var ta=div.children('textarea.raw:first');
        if(ta.length>0){
          content=ta.val();
        }
      }
    }
    return content;
  }
  //get the ordered file contents (from the editor)
  function getFileContents(json){
    var data=[];
    var temLi=getTemplateTabLi();
    if(temLi.length>0){
      var temPath=getElemPath(temLi);
      if(temPath!=undefined){
        //function to make sure a file contains one or more strings
        var hasSome=function(cont){
          var include=false;
          if(json.hasOwnProperty('has_some') && json.has_some.length>0){
            if(cont!=undefined){
              for(var c=0;c<json.has_some.length;c++){
                if(cont.indexOf(json.has_some[c])!==-1){
                  include=true;
                  break;
                }
              }
            }
          }else{
            include=true;
          }
          return include;
        };
        //function to make sure a file contains one or more strings
        var hasAll=function(cont){
          var include=true;
          if(json.hasOwnProperty('has_all') && json.has_all.length>0){
            if(cont!=undefined){
              for(var c=0;c<json.has_all.length;c++){
                if(cont.indexOf(json.has_all[c])===-1){
                  include=false;
                  break;
                }
              }
            }else{
              include=false;
            }
          }
          return include;
        };
        var stopBefore=function(which){
          var stopNow=false;
          if(json!=undefined){
            if(json.hasOwnProperty('stop_before')){
              var name=getPathName(which);
              var stopName=json['stop_before'];
              if(stopName==='.'){
                stopName=getPathName('.');
              }
              if(stopName===name){
                stopNow=true;
              }
            }
          }
          return stopNow;
        };
        var stopAfter=function(which){
          var stopNow=false;
          if(json!=undefined){
            if(json.hasOwnProperty('stop_after')){
              var name=getPathName(which);
              var stopName=json['stop_after'];
              if(stopName==='.'){
                stopName=getPathName('.');
              }
              if(stopName===name){
                stopNow=true;
              }
            }
          }
          return stopNow;
        };
        //function to decide if this file's data should be included in return
        var includeData=function(which){
          //include file data based on include exclude rules
          var include=true;
          if(json!=undefined){
            var ext=getPathExt(which);
            if(json.hasOwnProperty('include_ext')){
              include=false;
              if(json['include_ext'].indexOf(ext)!==-1){
                include=true;
              }
            }
            if(json.hasOwnProperty('exclude_ext')){
              if(json['exclude_ext'].indexOf(ext)!==-1){
                include=false;
              }
            }
          }
          return include;
        };
        if(!stopBefore(temPath)){
          //get the template.html content
          var temContent=getFileContent(temPath);
          if(includeData(temPath)){
            if(hasAll(temContent)){
              if(hasSome(temContent)){
                data.push({path:temPath, content:temContent});
              }
            }
          }
          if(!stopAfter(temPath)){
            var tabsUl=jQuery('#tabs:first').children('ul:first');
            //get all of the potential file names between [...] TRIANGLE_STRIP
            var matches=temContent.match(/\[(.*?)\]/g); var prevMatch='';
            for(var m=0;m<matches.length;m++){
              var match=matches[m];
              match=match.substring('['.length);
              match=match.substring(0, match.length-']'.length);
              var prevPath='';
              if(match.trim().indexOf('/')===0){
                if(prevMatch.trim()===match.substring(match.indexOf('/')+'/'.length).trim()){
                  //get the tab with this file name
                  var li=tabsUl.children('li[path$="'+prevMatch+'"]:first');
                  var liPath=getElemPath(li); prevPath=liPath;
                  if(liPath!=undefined){
                    if(!stopBefore(liPath)){
                      //include this tab's file data?
                      if(includeData(liPath,liContent)){
                        var liContent=getFileContent(liPath);
                        if(hasAll(liContent)){
                          if(hasSome(liContent)){
                            data.push({path:liPath, content:liContent});
                          }
                        }
                      }
                    }else{
                      break;
                    }
                  }
                }
              }
              prevMatch=match;
              if(stopAfter(prevPath)){
                break;
              }
            }
          }
        }
      }
    }
    return data;
  }
  //create or open the content menu, eg: when you press Command+I
  function openContentMenu(menuType){
    //==REUSE VALUES FOR CERTAIN MENU TYPES==
    var insertTitle='Insert';
    var insertOnOpen=function(){
      console.log('insert open');
    };
    var insertOnClose=function(){
      console.log('insert close');
    };
    //==CONFIGURE MENU TYPES==
    var menusJson={
      insert:{
        template:{
          title:insertTitle, onopen:insertOnOpen, onclose:insertOnClose
        },
        js:{
          title:insertTitle, onopen:insertOnOpen, onclose:insertOnClose
        }
      }
    };
    //==CREATE OR OPEN THE MENU==
    if(menusJson.hasOwnProperty(menuType)){
      var json=menusJson[menuType];
      //get active conten div
      var divWrap=getEditorDiv(getActiveTabLi());
      //get extension for active file
      var ext=getPathExt(divWrap);
      if(json.hasOwnProperty(ext)){
        json=json[ext];
        var menuBodiesWrap=divWrap.children('.content-menus:last').children('.menu-bodies:last');
        var menuBody=menuBodiesWrap.children('[name="'+menuType+'"]:first');
        //if this menuType isn't already created for this active tab
        if(menuBody.length<1){
          //create the menu
          menuBodiesWrap.append('<div name="'+menuType+'" class="menu-body"><h1>'+json['title']+'</h1><div class="scroll"></div></div>');
          menuBody=menuBodiesWrap.children('[name="'+menuType+'"]:last');
          //*** add menu content
          //close handler
          menuBody[0]['contentMenuClose']=function(){
            menuBody.removeClass('active');
            menuBodiesWrap.parent().parent().removeClass('show-content-menu');
            if(json.hasOwnProperty('onclose')){
              json['onclose']();
            }
          };
          //open handler
          menuBody[0]['contentMenuOpen']=function(){
            menuBodiesWrap.parent().parent().addClass('show-content-menu');
            menuBody.parent().children('.active').removeClass('active');
            menuBody.addClass('active');
            if(json.hasOwnProperty('onopen')){
              json['onopen']();
            }
          };
          //open the menu
          menuBody[0]['contentMenuOpen']();
        }else{
          //menu body already created...

          //toggle open the menu
          if(menuBody.hasClass('active')){
            menuBody[0]['contentMenuClose']();
          }else{
            menuBody[0]['contentMenuOpen']();
          }
        }
      }
    }
  }
  function getFilterInputStr(defaultTxt){
    if(defaultTxt==undefined){defaultTxt='filter';}
    var html='';
    html+='<span class="filter-box">';
    html+='<input type="text" value="'+defaultTxt+'" />';
    html+='<span class="filter-btn"></span>';
    html+='</span>';
    return html;
  }
  function addFilterBoxItem(filterBox,itemJson){
    if(filterBox.hasClass('filter-box')){
      var ul=filterBox.children('ul.filter-items:last');
      if(ul.length<1){
        filterBox.append('<ul class="filter-items"></ul>');
        ul=filterBox.children('ul.filter-items:last');
      }
      if(itemJson.hasOwnProperty('val')){
        if(itemJson.hasOwnProperty('txt')){
          ul.append('<li val="'+val+'">'+txt+'</li>');
          var li=ul.children('li:last');
          //item click action
          if(itemJson.hasOwnProperty('_action')){
            var actionEvent=itemJson['_action'];
            li[0]['itemClickAction']=actionEvent;
          }
          //init the onchange event for the filter box
          if(!filterBox[0].hasOwnProperty('filterChangeAction')){
            //set the filter change action for this filter-box
            filterBox[0]['filterChangeAction']=function(trigger){
              //if trigger is selecting a dropdown item
              switch(trigger[0].tagName.toLowerCase()){
                case 'li':
                  //***
                  //execute additional trigger action if any custom _action is assigned
                  if(trigger[0].hasOwnProperty('itemClickAction')){
                    trigger[0]['itemClickAction'](trigger);
                  }
                  break;
                case 'input':
                  //***
                  break;
              }
            };
            //set input events
            var input=filterBox.children('input:first');
            //***
          }
          //bind the new li trigger
          li.click(function(){
            filterBox[0]['filterChangeAction'](jQuery(this));
          });
        }
      }
    }
  }
  function setCodemirrorContent(fpath,textarea,callback){
    var wrap=textarea.parent();
    //get just the extension from the file path
    var ext=fpath;
    if(ext.indexOf('.')!==-1){
      ext=ext.substring(ext.lastIndexOf('.')+'.'.length);
    }else{ext='';}
    ext=ext.toLowerCase();
    //which codemirror mode to use based on the file path extension
    var mode=''; var hintType;
    switch(ext){
      case 'js': mode='javascript'; hintType='gljs'; break;
      case 'html': mode='htmlmixed'; break;
      case 'frag': mode='webglslfrag'; break;
      case 'vert': mode='webglslvert'; break;
      case 'txt': mode=''; break;
      case 'json': mode='javascript'; break;
      case 'css': mode='css'; break;
      default:
        break;
    }
    //set the codemirror config options
    var config={};
    config['value']=textarea.val();
    config['lineNumbers']=true;
    config['extraKeys']={
      'Ctrl-Space':'autocomplete'
    };
    config['styleActiveLine']=true;
    if(mode.length>0){
      config['mode']=mode;
    }
    //init the editor textarea
    var myCodeMirror = CodeMirror(function(el) {
      //textarea.removeClass('raw');
      textarea[0].parentNode.replaceChild(el, textarea[0]);
    },config);
    myCodeMirror['myHintType']=hintType;
    //codemirror editor events
    myCodeMirror.on('change', function(instance, object){
      //indicate unsaved change
      jQuery('body:first').addClass('has-changes');
      jQuery('nav#tabs').children('ul:first').children('li[path="'+fpath+'"]:first').addClass('has-changes');
      //autocomplete
      if(myCodeMirror['myHintType']){
        //show the hints dropdown
        myCodeMirror.showHint({
          eventTrigger:'change',
          completeSingle:false, //auto-complete when only one option remains?
          closeOnUnfocus:false, //close options dropdown when lose focus?
          hint:CodeMirror.hint[myCodeMirror['myHintType']] //what hints list?
        });
      }
    });
    //when mouse cursor position changes
    myCodeMirror.on('cursorActivity', function(instance, object){
      //autocomplete
      if(myCodeMirror['myHintType']){
        //show the hints dropdown
        myCodeMirror.showHint({
          eventTrigger:'cursorActivity',
          completeSingle:false, //auto-complete when only one option remains?
          closeOnUnfocus:false, //close options dropdown when lose focus?
          hint:CodeMirror.hint[myCodeMirror['myHintType']] //what hints list?
        });
      }
    });
    //create a placeholder for the content menus
    wrap.append('<div class="content-menus"></div>');
    var subMenus=wrap.children('.content-menus:last');
    subMenus.append('<div class="menu-bodies"></div>');
    subMenus.append('<div class="menu-btns"><div title="back to code" class="btn-cancel"></div></div>');
    var btnsWrap=subMenus.children('.menu-btns:first');
    var btnCancel=btnsWrap.children('.btn-cancel:first');
    //standard content menu events
    btnCancel.click(function(){
      var divWrap=getEditorDiv(getActiveTabLi());
      var divActive=divWrap.children('.content-menus:last').children('.menu-bodies:first').children('.active:first');
      if(divActive.length>0){
        divActive[0]['contentMenuClose']();
      }
    });
    //callback function
    if(callback!=undefined){
      callback(myCodeMirror, mode);
    }
  }
  function addFileTab(fpath,fcontent,isTemplateFile){
    if(isTemplateFile==undefined){isTemplateFile=false;}
    //get just the name without the path
    var fname=fpath;
    if(fname.indexOf('/')!==-1){
      fname=fname.substring(fname.lastIndexOf('/')+'/'.length);
    }
    //get key elements
    var tabsWrap=jQuery('#tabs:first');
    var ul=tabsWrap.children('ul:first');
    var filterBox;
    //init the ul list if not already init
    if(ul.length<1){
      tabsWrap.append('<ul><li name="_filter">'+getFilterInputStr('search tabs')+'</li></ul>');
      ul=tabsWrap.children('ul:first');
      var filterLi=ul.children('li:first');
      filterBox=filterLi.children('span.filter-box:first');
    }else{
      filterBox=ul.children('li[name="_filter"]:first').children('span.filter-box:first');
    }
    //create the tab, if not exists already
    if(ul.children('li[path="'+fpath+'"]:first').length<1){
      ul.append('<li title="'+fpath+'" path="'+fpath+'"><span>'+fname+'</span></li>');
      var newLi=ul.children('li:last');
      if(isTemplateFile){
        newLi.addClass('template');
      }
      //create the content for this tab
      var contentWrap=jQuery('section#file-content:first');
      if(contentWrap.children('div[path="'+fpath+'"]:first').length<1){
        contentWrap.append('<div class="content-wrap" path="'+fpath+'"></div>');
        var wrap=contentWrap.children('div:last');
        wrap.append('<textarea class="raw"></textarea>');
        var textarea=wrap.children('textarea:last');
        textarea.val(fcontent);
        if(isTemplateFile){
          wrap.addClass('template');
          //*** create the add tab method
        }
      }
      var showTabContent=function(cWrap,cDiv,tabLi){
        cWrap.children('div[path]').removeClass('active');
        cDiv.addClass('active');
        tabLi.parent().children('li').not('li[name="_filter"]').removeClass('active');
        tabLi.addClass('active');
      };
      var newSpan=newLi.children('span:first');
      newSpan.click(function(e){
        var tLi=jQuery(this).parent();
        var path=tLi.attr('path');
        var cWrap=jQuery('section#file-content:first');
        var cDiv=cWrap.children('div[path="'+path+'"]:first');
        if(cDiv.length>0){
          //if the textarea isn't codemirrored yet
          var cta=cDiv.children('textarea.raw:first');
          if(cta.length>0){
            //show the content after codemirror does its thing
            showTabContent(cWrap,cDiv,tLi);
            //codemirror the code
            setCodemirrorContent(path,cta,function(myCodeMirror,mode){
              //save the code mirror objects in the div property list
              cDiv[0]['codeMirror']={object:myCodeMirror,mode:mode};
            });
          }else{
            //already code mirrored... show this content for this tab
            showTabContent(cWrap,cDiv,tLi);
          }
        }
      });
    }
  }
  function clearProject(){
    var wrap=jQuery('#file-content:first');
    wrap.html('');
    var tabs=jQuery('#tabs:first');
    tabs.html('');
  }
  function loadPreviewIFrame(callback){
    //if the preview index iframe hasn't already been created
    var bodyElem=jQuery('body:first');
    var iframe=bodyElem.children('iframe#preview-index-iframe:first');
    if(iframe.length<1){
      //if not already in the process of loading the preview iframe
      if(!bodyElem.hasClass('loading-preview-iframe')){
        bodyElem.addClass('loading-preview-iframe');
        //ping the file to see if it's there
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange=function(){
          if (xmlhttp.readyState==4 && xmlhttp.status==200){
            var str=xmlhttp.responseText;
            var json=JSON.parse(str);
            //if no errors
            if(json.status==='ok'){
              if(json.hasOwnProperty('exists')){
                //if the /preview/index.html file exists
                if(json['exists']){
                  //prepend the iframe to the stage
                  bodyElem.prepend('<iframe id="preview-index-iframe" src="'+json['href']+'"></iframe>');
                  var iframe=bodyElem.children('iframe#preview-index-iframe:first');
                  iframe.error(function(){

                  });
                  iframe.load(function(){
                    //callback function (if any provided)
                    if(callback!=undefined){ callback(iframe[0]); }
                  });
                }
              }
              bodyElem.removeClass('loading-preview-iframe');
            }else{
              //returned errors...
              //*** display json.status
            }
          }
        }
        xmlhttp.open("GET","/preview-index-exists",true);
        xmlhttp.send();
      }
    }
  }
  function openProjectFile(){
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange=function(){
      if (xmlhttp.readyState==4 && xmlhttp.status==200){
        clearProject();
        var str=xmlhttp.responseText;
        var json=JSON.parse(str);
        //if no errors
        if(json.status==='ok'){
          //for each project embedded "file"
          if(json.hasOwnProperty('files')){
            for(path in json.files){
              if(json.files.hasOwnProperty(path)){
                var fileJson=json.files[path];
                if(fileJson.hasOwnProperty('content')){
                  if(fileJson.hasOwnProperty('path')){
                    var isTemplateFile=false;
                    if(path==='_.html'){isTemplateFile=true;}
                    //add the project file tab to the UI
                    addFileTab(fileJson.path,fileJson.content,isTemplateFile);
                  }
                }
              }
            }
          }
        }else{
          //returned errors...
          //*** display json.status
        }
      }
    }
    xmlhttp.open("GET","/open-project",true);
    xmlhttp.send();
  }
  function getPreviewWindow(){
    var previewWindow;
    if(document.body.hasOwnProperty('syntaxerPreviewWindow')){
      previewWindow=document.body['syntaxerPreviewWindow'];
      if(previewWindow.window==undefined){
        previewWindow=undefined;
      }
    }
    return previewWindow;
  }
  function refreshPreviewWindow(){
    var previewWindow=getPreviewWindow();
    if(previewWindow!=undefined){
      var href=previewWindow.window.location.href;
      if(href!=undefined && href.trim().length>0){
        if(href.indexOf('?')!==-1){
          href=href.substring(0,href.indexOf('?'));
        }
        if(href!=='about:blank'){
          href+='?reload='+(new Date()).getTime();
          previewWindow.window.location.href=href;
        }
      }
    }
    return previewWindow;
  }
  function openPreviewWindow(){
    //strip off qs params
    var host=document.location.href;
    if(host.indexOf('?')!==-1){
      host=host.substring(0,host.indexOf('?'));
    }
    //strip off path
    if(host.lastIndexOf('/')!==-1){
      host=host.substring(0, host.lastIndexOf('/'));
    }
    var width=window.innerWidth;
    var height=window.innerHeight;
    //open a popup window
    document.body['syntaxerPreviewWindow']=window.open(host + '/preview', 'syntaxer-preview-window',
      "toolbar=no, scrollbars=yes, resizable=yes, top=500, left=500, width="+width+", height="+height);
  }
  function initHud(){
    var navJson={
      project:{
        new:{
          _action:function(){
            console.log('new file');
          }
        },
        open:{
          _action:function(){
            openProjectBrowse('open-project');
          }
        },
        save:{
          _action:function(){
            saveProject();
          }
        },
        saveas:{
          _action:function(){
            console.log('saveas file');
          }
        }
      },
      edit:{
        undo:{
          _action:function(){
            console.log('undo action');
          }
        },
        redo:{
          _action:function(){
            console.log('redo action');
          }
        }
      },
      preview:{
        showwindow:{
          _action:function(){
            openPreviewWindow();
          }
        },
        reloadwindow:{
          _action:function(){
            openPreviewWindow();
            refreshPreviewWindow();
          }
        }
      }
    };
    //loop through nav and init items
    var hudWrap=jQuery('nav#hud:first');
    var topUl=hudWrap.children('ul:first');
    var initNavLevel=function(levelJson, ul, level){
      ul.addClass('lvl'+level);
      for(name in levelJson){
        if(levelJson.hasOwnProperty(name)&&name.indexOf('_')!==0){
          var li=ul.children('li[name="'+name+'"]:first')
          if(li.length>0){
            li.addClass('lvl'+level);
            var itemJson=levelJson[name];
            //menu item click event
            var span=li.children('span:first');
            if(span.length>0){
              if(itemJson.hasOwnProperty('_action')){
                var actionFunc=itemJson['_action'];
                span[0]['navClickAction']=actionFunc;
                span.click(function(e){
                  e.preventDefault();
                  jQuery(this)[0]['navClickAction'](li);
                });
              }
            }
            //if parent item
            var subUl=li.children('ul:last');
            if(subUl.length>0){
              li.addClass('parent');
              //recursive get the sub items
              initNavLevel(itemJson, subUl, level+1);
            }
          }
        }
      }
    };
    initNavLevel(navJson, topUl, 0);
  }
  function saveProject(){
    //if there are any project changes
    var bodyElem=jQuery('body:first');
    if(bodyElem.hasClass('has-changes')){
      bodyElem.removeClass('has-changes');
      //build the save data
      var saveData={files:{}};
      var contentWrap=jQuery('#file-content:first');
      //each tab that has changes
      jQuery('nav#tabs ul li.has-changes[path]').each(function(){
        var li=jQuery(this); li.removeClass('has-changes');
        var path=li.attr('path');
        //get the codemirror object
        var cDiv=contentWrap.children('div.content-wrap[path="'+path+'"]:first');
        var cm=cDiv[0]['codeMirror'];
        if(cm!=undefined){
          //set the json values for the changes
          if(li.hasClass('template')){ path='_.html'; }
          saveData['files'][path]={};
          saveData['files'][path]['content']=cm['object']['doc'].getValue();
        }
      });
      // construct an HTTP request
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/save-project', true);
      xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
      xhr.onloadend=function(res){
        //if the server responded with ok status
        var res=JSON.parse(this.responseText);
        if(res.status==='ok'){
          //if any tab content was saved
          if(res.count>0){
            //refresh preview window, if open
            refreshPreviewWindow();
          }
        }
      };
      // send the collected data as JSON
      xhr.send(JSON.stringify(saveData));
    }
  }
  //request the file system folders and files for the current directory
  function requestProjectFiles(callback,requestedPath){
    if(callback!=undefined){
      // construct an HTTP request
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/browse-project-files', true);
      xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
      xhr.onloadend=function(res){
        //if the server responded with ok status
        var res=JSON.parse(this.responseText);
        callback(res);
      };
      if(requestedPath==undefined){
        requestedPath='';
      }
      var send={path:requestedPath};
      // send the collected data as JSON
      xhr.send(JSON.stringify(send));
    }
  }
  //update the browse path for the project browse dialag box
  function updateProjectBrowse(path){
    if(path==undefined){path='';}
    requestProjectFiles(function(data){
      var box=jQuery('body section#lightbox .box.open:first');
      var browseWrap=box.find('.box-col.browse:first');
      var navBarInput=browseWrap.find('.nav-bar input.path:first');
      var scrollWrap=browseWrap.find('.scroll:first');
      if(data.status==='ok'){
        //set the path
        navBarInput.val(data.path);
        navBarInput[0]['currentBrowsePath']=data.path;
        navBarInput.removeClass('edit-path');
        //clear browser contents
        scrollWrap.html('');
        //if there are any directories or folders
        if(data.dirs.length>0 || data.files.length>0){
          var html='<ul class="files">';
          //for each directory
          var dirs=data.dirs.sort();
          for(var d=0;d<dirs.length;d++){
            var dir=dirs[d];
            html+='<li class="dir" path="'+data.path+'/'+dir+'">';
            html+='<span class="icon">'+svgDir+'</span>';
            html+='<span class="txt">'+dir+'</span>';
            html+='</li>';
          }
          //get the current project file from the url
          var currentFile='';
          var qs=getQs();
          if(qs.hasOwnProperty('file')){
            currentFile=decodeURIComponent(qs.file);
          }
          //for each file
          var files=data.files.sort();
          for(var f=0;f<files.length;f++){
            var file=files[f]; var fileData=data.filesData[file];
            var statusClass='ok '; if(fileData.status!=='ok'){ statusClass='invalid '; }
            var fpath=data.path+'/'+file;
            var currentClass='';
            if(currentFile===fpath){currentClass='current ';}
            html+='<li class="'+statusClass+currentClass+'file" path="'+fpath+'">';
            html+='<span class="icon">'+svgFile+'</span>';
            html+='<span class="txt">'+file+'</span>';
            html+='</li>';
          }
          html+='</ul>';
          //set the html
          scrollWrap.html(html);
          //file events
          scrollWrap.find('ul.files > li').not('.invalid').not('.current').each(function(){
            jQuery(this).click(function(e){
              e.preventDefault();
              //get the ok button
              var boxBtns=box.children('.box-btns');
              var openBtn=boxBtns.children('.box-btn.open:last');
              //set the selected class
              jQuery(this).parent().children('.selected').removeClass('selected');
              jQuery(this).addClass('selected');
              if(jQuery(this).hasClass('file')){
                var selFile=jQuery(this).attr('path');
                var url=document.location.href;
                if(url.indexOf('?')!==-1){
                  url=url.substring(0,url.lastIndexOf('?'));
                }
                url+='?file='+encodeURIComponent(selFile);
                openBtn.attr('href',url);
                openBtn.removeClass('disabled');
              }else{
                //directory clicked...
                openBtn.addClass('disabled');
                //follow the directory path
                var followPath=jQuery(this).attr('path');
                updateProjectBrowse(followPath);
              }
            });
          });
        }else{
          scrollWrap.html('<p class="msg">folder empty...</p>');
        }
      }else{
        //something wrong with the data.status
        navBarInput.addClass('err-path');
        setTimeout(function(){
          navBarInput.removeClass('err-path');
        },180);
      }
    }, path);
  }
  //open project browse dialog box
  function openProjectBrowse(boxId){
    //if browse events not already init
    var box=jQuery('body section#lightbox #'+boxId+':first');
    if(!box.hasClass('evs')){
      //init browse events
      box.addClass('evs');
      var browseWrap=box.find('.box-col.browse:first');
      var navBarInput=browseWrap.find('.nav-bar input.path:first');
      var upDirBtn=browseWrap.find('.up-dir-btn:last');
      var openBtn=box.children('.box-btns:last').children('.box-btn.open:last');
      navBarInput.keydown(function(e){
        //if enter key pressed
        switch(e.keyCode){
          case 13: //enter key
            e.preventDefault(); e.stopPropagation();
            var newBrowsePath=navBarInput.val(); newBrowsePath=newBrowsePath.trim();
            navBarInput.val(newBrowsePath);
            updateProjectBrowse(newBrowsePath);
          break;
          case 9: //tab key
            e.preventDefault(); e.stopPropagation();
            //***
          break;
          case 27: //esc key
            e.preventDefault(); e.stopPropagation();
            if(jQuery(this)[0].hasOwnProperty('currentBrowsePath')){
              //reset to the current directory
              var currentDirPath=jQuery(this)[0]['currentBrowsePath'];
              jQuery(this).val(currentDirPath);
              jQuery(this).removeClass('edit-path');
            }
          break;
        }
      });
      navBarInput.keyup(function(e){
        //if the path in the input box isn't the current path
        if(jQuery(this)[0]['currentBrowsePath']!==jQuery(this).val()){
          jQuery(this).addClass('edit-path');
        }else{
          //the path in the input box is the current path
          jQuery(this).removeClass('edit-path');
        }
      });
      navBarInput.blur(function(){
        var current=jQuery(this).val();
        if(current.trim().length<1){
          if(jQuery(this)[0].hasOwnProperty('currentBrowsePath')){
            //reset to the current directory
            var currentDirPath=jQuery(this)[0]['currentBrowsePath'];
            jQuery(this).val(currentDirPath);
            jQuery(this).removeClass('edit-path');
          }
        }
      });
      upDirBtn.click(function(e){
        var input=jQuery(this).parent().children('input.path:first');
        if(input[0].hasOwnProperty('currentBrowsePath')){
          //reset to the current directory
          var currentDirPath=input[0]['currentBrowsePath'];
          input.val(currentDirPath);
          input.removeClass('edit-path');
          if(currentDirPath.lastIndexOf('/')===currentDirPath.length-'/'.length){
            currentDirPath=currentDirPath.substring(0, currentDirPath.length-'/'.length);
          }
          if(currentDirPath.indexOf('/')!==-1){
            if(currentDirPath.length>'/'.length){
              var upDirPath=currentDirPath.substring(0, currentDirPath.lastIndexOf('/'));
              updateProjectBrowse(upDirPath);
            }
          }
        }
      });
      openBtn.click(function(e){
        var ret=true;
        if(jQuery(this).hasClass('disabled')){
          e.preventDefault();
          ret =false;
        } return ret;
      });
    }
    //open the project browse lightbox
    openLightBox('open-project',function(box){
      //update the project browse items
      updateProjectBrowse();
    });
  }
  function openLightBox(id,callback){
    var bodyElem=jQuery('body:first');
    if(!bodyElem.hasClass('lightbox-open')){
      var lbWrap=bodyElem.children('section#lightbox:last');
      var box=lbWrap.children('.box#'+id+':first');
      if(box.length>0){
        bodyElem.addClass('lightbox-open');
        box.addClass('open');
        if(callback!=undefined){
          callback(box);
        }
      }
    }
  }
  function closeLightBox(callback){
    var bodyElem=jQuery('body:first');
    if(bodyElem.hasClass('lightbox-open')){
      var lbWrap=bodyElem.children('section#lightbox:last');
      var openBoxes=lbWrap.children('.box.open');
      openBoxes.removeClass('open');
      bodyElem.removeClass('lightbox-open');
      if(callback!=undefined){
        callback(openBoxes);
      }
    }
  }
  function initLightbox(){
    var lbWrap=jQuery('body section#lightbox:last');
    lbWrap.children('.box').each(function(){
      var box=jQuery(this);
      var cancelBtns=box.find('.box-btn.cancel');
      cancelBtns.click(function(){
        closeLightBox();
      });
    });
  }
  //handle detect key events
  function initKeyEvents(){
    jQuery(window).keydown(function(e) {
      var ret=true;
      //function to decide if the ctl/cmd key is held
      var isCtl=function(evt){
        var is=false;
        if(e.metaKey||e.ctrlKey){
          is=true;
        }return is;
      };
      //if the command or control key is held
      if(isCtl(e)){
        //get character
        var char=String.fromCharCode(e.keyCode); if(char==undefined){char='';}
        char=char.toLowerCase();
        //depending on character
        switch(char){
          case 's':
            //if Command+S
            e.preventDefault(); ret=false;
            saveProject();
            break;
          case 'i':
            //if Command+I
            e.preventDefault(); ret=false;
            openContentMenu('insert');
            break;
        }
      }else{
        //command/control key not held...

      }
      return ret;
    });
  }
  function initSyntaxer(){
    initHud();
    openProjectFile();
    initLightbox();
    initKeyEvents();
  }
</script>
</head>
<body id="body" onload="javascript:initSyntaxer();">
  <section id="file-content"></section>
  <section id="hints-info">
    <div class="info-title"></div>
    <div class="info-body"></div>
  </section>
  <nav id="tabs"></nav>
  <nav id="hud">
    <ul>
      <li name="project"><span>Project</span>
        <ul>
          <li name="new"><span>New</span></li>
          <li name="open"><span>Open</span></li>
          <li name="save"><span>Save</span></li>
          <li name="saveas"><span>Save As</span></li>
        </ul>
      </li>
      <li name="edit"><span>Edit</span>
        <ul>
          <li name="undo"><span>Undo</span></li>
          <li name="redo"><span>Redo</span></li>
        </ul>
      </li>
      <li name="preview"><span>Preview</span>
        <ul>
          <li name="showwindow"><span>Show Window</span></li>
          <li name="reloadwindow"><span>Reload Window</span></li>
        </ul>
      </li>
    </ul>
  </nav>
  <section id="lightbox">
    <div class="box" id="open-project">
      <h1>Open Project<span class="box-btn cancel">X</span></h1>
      <div class="box-content explorer">
        <div class="box-col recent-projects">
          <h2>Recent</h2>
          <div class="scroll">
            <p class="msg no-recent">No recent projects...</p>
          </div>
        </div>
        <div class="box-col browse">
          <h2>Browse</h2>
          <div class="nav-bar">
            <input class="path" type="text" />
            <div class="up-dir-btn">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 640 640"><path d="M241.808 476.333v-211.145h-78.192l114.682-125.108 114.657 125.108h-78.192v190.268h161.624v73.006h-182.449c-28.775 0-52.128-23.327-52.128-52.128z"></path></svg>
            </div>
          </div>
          <div class="scroll"></div>
        </div>
      </div>
      <div class="box-btns">
        <div class="box-btn left-btn remove-recent disabled">Remove from Recent</div>
        <div class="box-btn cancel">Cancel</div>
        <a href="#" class="box-btn open disabled">Open</a>
      </div>
    </div>
  </section>
</body>
</html>
