<html>
<head>
<title>Syntaxer</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="favicon.ico?nocache=syntaxer" />

<link type="text/css" rel="stylesheet" href="css/styles.css" />
<script type="text/javascript" src="js/codemirror.js"></script>
<!-- modes -->
<script type="text/javascript" src="js/mode/javascript.js"></script>
<script type="text/javascript" src="js/mode/css.js"></script>
<script type="text/javascript" src="js/mode/xml.js"></script>
<script type="text/javascript" src="js/mode/htmlmixed.js"></script>
<script type="text/javascript" src="js/mode/webglslvert.js"></script>
<script type="text/javascript" src="js/mode/webglslfrag.js"></script>
<!-- end modes -->
<!-- addons -->
<script type="text/javascript" src="js/addon/show-hint.js"></script>
<script type="text/javascript" src="js/addon/hint-functions.js"></script>
<script type="text/javascript" src="js/addon/gljs-hint.js"></script>
<!--<script type="text/javascript" src="js/addon/anyword-hint.js"></script>-->
<!-- end addons -->
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript">
  function getActiveTabLi(){
    return jQuery('#tabs:first').children('ul:first').children('li.active[path]:first');
  }
  function getElemPath(arg){
    var path;
    if(arg!=undefined){
      if(typeof arg==='string'){
        path=arg;
        //make sure this is a real path and not just a random string
        if(jQuery('#tabs > ul > li[path="'+path+'"]:first').length<1){path=undefined;}
      }else if(arg.attr){
        //if this element doesn't have a path attribute
        path=arg.attr('path');
        if(path==undefined){path='';}
        if(path.length<1){
          //if a parent element has a path attribute
          var parent=arg.parents('[path]:first');
          if(parent.length>0){
            path=parent.attr('path');
          }else{
            //no path associated with this element
            path=undefined;
          }
        }
      }
    }
    return path;
  }
  function getEditorDiv(which){
    var div;
    var path=getElemPath(which);
    if(path!=undefined){
      div=jQuery('#file-content:first').children('div[path="'+path+'"]:first');
      if(div.length<1){
        div=undefined;
      }
    }
    return div;
  }
  function getCodeMirrorObj(which){
    var cm;
    //if there is a codemirror object for this
    var div=getEditorDiv(which);
    if(div!=undefined){
      if(div[0].hasOwnProperty('codeMirror')){
        cm=div[0]['codeMirror'];
      }
    }
    return cm;
  }
  function getTabLi(which){
    var li;
    var path=getElemPath(which);
    if(path!=undefined){
      li=jQuery('#tabs:first').children('ul:first').children('li[path="'+path+'"]:first');
      if(li.length<1){
        li=undefined;
      }
    }
    return li;
  }
  function getFilterInputStr(defaultTxt){
    if(defaultTxt==undefined){defaultTxt='filter';}
    var html='';
    html+='<span class="filter-box">';
    html+='<input type="text" value="'+defaultTxt+'" />';
    html+='<span class="filter-btn"></span>';
    html+='</span>';
    return html;
  }
  function addFilterBoxItem(filterBox,itemJson){
    if(filterBox.hasClass('filter-box')){
      var ul=filterBox.children('ul.filter-items:last');
      if(ul.length<1){
        filterBox.append('<ul class="filter-items"></ul>');
        ul=filterBox.children('ul.filter-items:last');
      }
      if(itemJson.hasOwnProperty('val')){
        if(itemJson.hasOwnProperty('txt')){
          ul.append('<li val="'+val+'">'+txt+'</li>');
          var li=ul.children('li:last');
          //item click action
          if(itemJson.hasOwnProperty('_action')){
            var actionEvent=itemJson['_action'];
            li[0]['itemClickAction']=actionEvent;
          }
          //init the onchange event for the filter box
          if(!filterBox[0].hasOwnProperty('filterChangeAction')){
            //set the filter change action for this filter-box
            filterBox[0]['filterChangeAction']=function(trigger){
              //if trigger is selecting a dropdown item
              switch(trigger[0].tagName.toLowerCase()){
                case 'li':
                  //***
                  //execute additional trigger action if any custom _action is assigned
                  if(trigger[0].hasOwnProperty('itemClickAction')){
                    trigger[0]['itemClickAction'](trigger);
                  }
                  break;
                case 'input':
                  //***
                  break;
              }
            };
            //set input events
            var input=filterBox.children('input:first');
            //***
          }
          //bind the new li trigger
          li.click(function(){
            filterBox[0]['filterChangeAction'](jQuery(this));
          });
        }
      }
    }
  }
  function setCodemirrorContent(fpath,textarea,callback){
    //get just the extension from the file path
    var ext=fpath;
    if(ext.indexOf('.')!==-1){
      ext=ext.substring(ext.lastIndexOf('.')+'.'.length);
    }else{ext='';}
    ext=ext.toLowerCase();
    //which codemirror mode to use based on the file path extension
    var mode=''; var hintType;
    switch(ext){
      case 'js': mode='javascript'; hintType='gljs'; break;
      case 'html': mode='htmlmixed'; break;
      case 'frag': mode='webglslfrag'; break;
      case 'vert': mode='webglslvert'; break;
      case 'txt': mode=''; break;
      case 'json': mode='javascript'; break;
      case 'css': mode='css'; break;
      default:
        break;
    }
    //set the codemirror config options
    var config={};
    config['value']=textarea.val();
    config['lineNumbers']=true;
    config['extraKeys']={'Ctrl-Space':'autocomplete'};
    if(mode.length>0){
      config['mode']=mode;
    }
    //init the editor textarea
    var myCodeMirror = CodeMirror(function(el) {
      //textarea.removeClass('raw');
      textarea[0].parentNode.replaceChild(el, textarea[0]);
    },config);
    myCodeMirror['myHintType']=hintType;
    //codemirror editor events
    myCodeMirror.on('change', function(instance, object){
      //indicate unsaved change
      jQuery('body:first').addClass('has-changes');
      jQuery('nav#tabs').children('ul:first').children('li[path="'+fpath+'"]:first').addClass('has-changes');
      //autocomplete
      if(myCodeMirror['myHintType']){
        //show the hints dropdown
        myCodeMirror.showHint({
          completeSingle:false, //auto-complete when only one option remains?
          closeOnUnfocus:false, //close options dropdown when lose focus?
          hint:CodeMirror.hint[myCodeMirror['myHintType']] //what hints list?
        });
      }
    });
    //callback function
    if(callback!=undefined){
      callback(myCodeMirror, mode);
    }
  }
  function addFileTab(fpath,fcontent,isTemplateFile){
    if(isTemplateFile==undefined){isTemplateFile=false;}
    //get just the name without the path
    var fname=fpath;
    if(fname.indexOf('/')!==-1){
      fname=fname.substring(fname.lastIndexOf('/')+'/'.length);
    }
    //get key elements
    var tabsWrap=jQuery('#tabs:first');
    var ul=tabsWrap.children('ul:first');
    var filterBox;
    //init the ul list if not already init
    if(ul.length<1){
      tabsWrap.append('<ul><li name="_filter">'+getFilterInputStr('search tabs')+'</li></ul>');
      ul=tabsWrap.children('ul:first');
      var filterLi=ul.children('li:first');
      filterBox=filterLi.children('span.filter-box:first');
    }else{
      filterBox=ul.children('li[name="_filter"]:first').children('span.filter-box:first');
    }
    //create the tab, if not exists already
    if(ul.children('li[path="'+fpath+'"]:first').length<1){
      ul.append('<li title="'+fpath+'" path="'+fpath+'"><span>'+fname+'</span></li>');
      var newLi=ul.children('li:last');
      if(isTemplateFile){
        newLi.addClass('template');
      }
      //create the content for this tab
      var contentWrap=jQuery('section#file-content:first');
      if(contentWrap.children('div[path="'+fpath+'"]:first').length<1){
        contentWrap.append('<div class="content-wrap" path="'+fpath+'"></div>');
        var wrap=contentWrap.children('div:last');
        wrap.append('<textarea class="raw"></textarea>');
        var textarea=wrap.children('textarea:last');
        textarea.val(fcontent);
      }
      var showTabContent=function(cWrap,cDiv,tabLi){
        cWrap.children('div[path]').removeClass('active');
        cDiv.addClass('active');
        tabLi.parent().children('li').not('li[name="_filter"]').removeClass('active');
        tabLi.addClass('active');
      };
      var newSpan=newLi.children('span:first');
      newSpan.click(function(e){
        var tLi=jQuery(this).parent();
        var path=tLi.attr('path');
        var cWrap=jQuery('section#file-content:first');
        var cDiv=cWrap.children('div[path="'+path+'"]:first');
        if(cDiv.length>0){
          //if the textarea isn't codemirrored yet
          var cta=cDiv.children('textarea.raw:first');
          if(cta.length>0){
            //show the content after codemirror does its thing
            showTabContent(cWrap,cDiv,tLi);
            //codemirror the code
            setCodemirrorContent(path,cta,function(myCodeMirror,mode){
              //save the code mirror objects in the div property list
              cDiv[0]['codeMirror']={object:myCodeMirror,mode:mode};
            });
          }else{
            //already code mirrored... show this content for this tab
            showTabContent(cWrap,cDiv,tLi);
          }
        }
      });
    }
  }
  function clearProject(){
    var wrap=jQuery('#file-content:first');
    wrap.html('');
    var tabs=jQuery('#tabs:first');
    tabs.html('');
  }
  function openProjectFile(){
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange=function(){
      if (xmlhttp.readyState==4 && xmlhttp.status==200){
        clearProject();
        var str=xmlhttp.responseText;
        var json=JSON.parse(str);
        //if no errors
        if(json.status==='ok'){
          //for each project embedded "file"
          if(json.hasOwnProperty('files')){
            for(path in json.files){
              if(json.files.hasOwnProperty(path)){
                var fileJson=json.files[path];
                if(fileJson.hasOwnProperty('content')){
                  if(fileJson.hasOwnProperty('path')){
                    var isTemplateFile=false;
                    if(path==='_.html'){isTemplateFile=true;}
                    //add the project file tab to the UI
                    addFileTab(fileJson.path,fileJson.content,isTemplateFile);
                  }
                }
              }
            }
          }
        }else{
          //returned errors...
          //*** display json.status
        }
      }
    }
    xmlhttp.open("GET","/open-project",true);
    xmlhttp.send();
  }
  function getPreviewWindow(){
    var previewWindow;
    if(document.body.hasOwnProperty('syntaxerPreviewWindow')){
      previewWindow=document.body['syntaxerPreviewWindow'];
      if(previewWindow.window==undefined){
        previewWindow=undefined;
      }
    }
    return previewWindow;
  }
  function refreshPreviewWindow(){
    var previewWindow=getPreviewWindow();
    if(previewWindow!=undefined){
      var href=previewWindow.window.location.href;
      if(href.indexOf('?')!==-1){
        href=href.substring(0,href.indexOf('?'));
      }
      href+='?reload='+(new Date()).getTime();
      previewWindow.window.location.href=href;
    }
    return previewWindow;
  }
  function openPreviewWindow(){
    //strip off qs params
    var host=document.location.href;
    if(host.indexOf('?')!==-1){
      host=host.substring(0,host.indexOf('?'));
    }
    //strip off path
    if(host.lastIndexOf('/')!==-1){
      host=host.substring(0, host.lastIndexOf('/'));
    }
    var width=window.innerWidth;
    var height=window.innerHeight;
    //open a popup window
    document.body['syntaxerPreviewWindow']=window.open(host + '/preview', 'syntaxer-preview-window',
      "toolbar=no, scrollbars=yes, resizable=yes, top=500, left=500, width="+width+", height="+height);
  }
  function initHud(){
    var navJson={
      project:{
        new:{
          _action:function(){
            console.log('new file');
          }
        },
        openrecent:{
          _action:function(){
            console.log('open recent');
          }
        },
        save:{
          _action:function(){
            saveProject();
          }
        },
        saveas:{
          _action:function(){
            console.log('saveas file');
          }
        }
      },
      edit:{
        undo:{
          _action:function(){
            console.log('undo action');
          }
        },
        redo:{
          _action:function(){
            console.log('redo action');
          }
        }
      },
      preview:{
        showwindow:{
          _action:function(){
            openPreviewWindow();
          }
        },
        reloadwindow:{
          _action:function(){
            openPreviewWindow();
            refreshPreviewWindow();
          }
        }
      }
    };
    //loop through nav and init items
    var hudWrap=jQuery('nav#hud:first');
    var topUl=hudWrap.children('ul:first');
    var initNavLevel=function(levelJson, ul, level){
      ul.addClass('lvl'+level);
      for(name in levelJson){
        if(levelJson.hasOwnProperty(name)&&name.indexOf('_')!==0){
          var li=ul.children('li[name="'+name+'"]:first')
          if(li.length>0){
            li.addClass('lvl'+level);
            var itemJson=levelJson[name];
            //menu item click event
            var span=li.children('span:first');
            if(span.length>0){
              if(itemJson.hasOwnProperty('_action')){
                var actionFunc=itemJson['_action'];
                span[0]['navClickAction']=actionFunc;
                span.click(function(e){
                  e.preventDefault();
                  jQuery(this)[0]['navClickAction'](li);
                });
              }
            }
            //if parent item
            var subUl=li.children('ul:last');
            if(subUl.length>0){
              li.addClass('parent');
              //recursive get the sub items
              initNavLevel(itemJson, subUl, level+1);
            }
          }
        }
      }
    };
    initNavLevel(navJson, topUl, 0);
  }
  function saveProject(){
    //if there are any project changes
    var bodyElem=jQuery('body:first');
    if(bodyElem.hasClass('has-changes')){
      bodyElem.removeClass('has-changes');
      //build the save data
      var saveData={files:{}};
      var contentWrap=jQuery('#file-content:first');
      //each tab that has changes
      jQuery('nav#tabs ul li.has-changes[path]').each(function(){
        var li=jQuery(this); li.removeClass('has-changes');
        var path=li.attr('path');
        //get the codemirror object
        var cDiv=contentWrap.children('div.content-wrap[path="'+path+'"]:first');
        var cm=cDiv[0]['codeMirror'];
        if(cm!=undefined){
          //set the json values for the changes
          if(li.hasClass('template')){ path='_.html'; }
          saveData['files'][path]={};
          saveData['files'][path]['content']=cm['object']['doc'].getValue();
        }
      });
      // construct an HTTP request
      var xhr = new XMLHttpRequest();
      xhr.open('POST', '/save-project', true);
      xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
      xhr.onloadend=function(res){
        //if the server responded with ok status
        var res=JSON.parse(this.responseText);
        if(res.status==='ok'){
          //if any tab content was saved
          if(res.count>0){
            //refresh preview window, if open
            refreshPreviewWindow();
          }
        }
      };
      // send the collected data as JSON
      xhr.send(JSON.stringify(saveData));
    }
  }
  //handle toggle open insert menu
  function insertMenu(){
    //if there is an active tab
    /*var tabLi=getActiveTabLi();
    if(tabLi.length>0){
      //if this tab li has a path (it should)
      var path=getElemPath(tabLi);
      if(path!=undefined){
        //if there is an editor object for this menu (should exist)
        var cm=getCodeMirrorObj(path);
        if(cm!=undefined){
          //get the path extension
          var ext=path;
          if(ext.indexOf('.')!==-1){
            ext=ext.substring(ext.lastIndexOf('.')+'.'.length);
          } ext=ext.toLowerCase(); ext=ext.trim();
          if(ext==='html'){
            if(tabLi.hasClass('template')){
              ext='template';
            }
          }
          //hint options
          var options={
            'template':['[file.extension]','test'],
            'html':{},
            'js':{},
            'frag':{},
            'vert':{}
          };
          //show options
          if(options.hasOwnProperty(ext)){
            //show options menu
            cm['object'].showHint(options[ext]);
          }
        }
      }
    }*/
  }
  //handle detect key events
  function initKeyEvents(){
    jQuery(window).keydown(function(e) {
      var ret=true;
      //function to decide if the ctl/cmd key is held
      var isCtl=function(evt){
        var is=false;
        if(e.metaKey||e.ctrlKey){
          is=true;
        }return is;
      };
      //get character
      var char=String.fromCharCode(e.keyCode); if(char==undefined){char='';}
      char=char.toLowerCase();
      //depending on character
      switch(char){
        case 's':
          //if Command+S
          if(isCtl(e)){
            e.preventDefault(); ret=false;
            saveProject();
          }
          break;
        case 'i':
          //if Command+I
          if(isCtl(e)){
            e.preventDefault(); ret=false;
            insertMenu();
          }
          break;
      }
      return ret;
    });
  }
  function initSyntaxer(){
    initHud();
    openProjectFile();
    initKeyEvents();
  }
</script>
</head>
<body id="body" onload="javascript:initSyntaxer();">
  <section id="file-content"></section>
  <nav id="tabs"></nav>
  <nav id="hud">
    <ul>
      <li name="project"><span>Project</span>
        <ul>
          <li name="new"><span>New</span></li>
          <li name="openrecent"><span>Open Recent</span></li>
          <li name="save"><span>Save</span></li>
          <li name="saveas"><span>Save As</span></li>
        </ul>
      </li>
      <li name="edit"><span>Edit</span>
        <ul>
          <li name="undo"><span>Undo</span></li>
          <li name="redo"><span>Redo</span></li>
        </ul>
      </li>
      <li name="preview"><span>Preview</span>
        <ul>
          <li name="showwindow"><span>Show Window</span></li>
          <li name="reloadwindow"><span>Reload Window</span></li>
        </ul>
      </li>
    </ul>
  </nav>
</body>
</html>
